<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\VulnerabilityMap;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use DataTables;
use Illuminate\Support\Facades\Validator;


class VulnerabilityMapController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $data = DB::table('vulnerable_areas')
                ->where('deleted_at', null)
                ->where('brgy_loc', Auth::user()->brgy_loc)
                ->get();
            return DataTables::of($data)
                ->addIndexColumn()
                ->addColumn('action', function ($row) {

                    if ($row->is_approved == '0') {
                        return '<div class="d-flex justify-content-center align-items-center">
                    <div class="dropdown" style="text-align:center;">
                        <a href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v text-primary fa-2x"></i>
                        </a>
                      
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                          <a class="dropdown-item" data-id="' . $row->id . '" id="approveVulnerabilityBtn">Approve</a>
                          <a class="dropdown-item" href=' . \URL::route('user.vulnerabilitymap.edit', $row->id) . '>Edit</a>
                          <a class="dropdown-item" data-id="' . $row->id . '" id="deleteVulnerabilityMapBtn">Delete</a>
                        </div>
                      </div>

                      </div>
                      ';
                    } else {
                        return '<div class="d-flex justify-content-center align-items-center">
                        <div class="dropdown" style="text-align:center;">
                            <a href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-ellipsis-v text-primary fa-2x"></i>
                            </a>
                          
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                              <a class="dropdown-item" href=' . \URL::route('user.vulnerabilitymap.edit', $row->id) . '>Edit</a>
                              <a class="dropdown-item" data-id="' . $row->id . '" id="deleteVulnerabilityMapBtn">Delete</a>
                            </div>
                          </div>
    
                          </div>
                          ';
                    }
                })

                ->addColumn('is_approved', function ($row) {
                    if ($row->is_approved == '1') {
                        return '<label class="badge badge-success">Approved</label>';
                    } else {
                        return '<label class="badge badge-danger">Not yet Approved</label>';
                    }
                })

                ->addColumn('degree', function ($row) {
                    if ($row->degree == 'High') {
                        return '<label class="badge badge-danger">High Vulnerability</label>';
                    } else {
                        return '<label class="badge badge-warning">Medium Vulnerability</label>';
                    }
                })

                ->editColumn('created_at', function ($row) {
                    $formatedDate = Carbon::createFromFormat('Y-m-d H:i:s', $row->created_at)->format('F d, Y \a\t h:i A');
                    return $formatedDate;
                })

                ->rawColumns(['action', 'is_approved', 'degree'])
                ->make(true);
        }
        //$coordinates = VulnerabilityMap::all()->where('deleted_at', NULL)->paginate(2);
        $barangays = DB::table('barangays')
            ->where('brgy_loc', Auth::user()->brgy_loc)
            ->get();

        $vulnerableareas = VulnerabilityMap::where('deleted_at', NULL)->where('brgy_loc', Auth::user()->brgy_loc)->paginate(3);
        $allvulnerableareas = VulnerabilityMap::where('deleted_at', null)->where('brgy_loc', Auth::user()->brgy_loc)->get();

        $approvedareas = VulnerabilityMap::where('deleted_at', null)->where('brgy_loc', Auth::user()->brgy_loc)->where('is_approved', 1)->paginate(3); //for resident
        return view('features.viewvulnerabilitymap', [
            //"coordinates" => $coordinates,
            'vulnerableareas' => $vulnerableareas,
            'barangays' => $barangays,
            'allvulnerableareas' => $allvulnerableareas,
            'approvedareas' => $approvedareas,
        ]);
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        $barangays = DB::table('barangays')
            ->where('brgy_loc', Auth::user()->brgy_loc)
            ->get();
        $coordinates = VulnerabilityMap::where('deleted_at', NULL)->where('brgy_loc', Auth::user()->brgy_loc)->get();
        return view('features.createvulnerabilitymap', [
            'coordinates' => $coordinates,
            'barangays' => $barangays,

        ]);
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'nearest_landmark' => 'required',
            'type' => 'required',
            'brgy_loc' => 'required',
            'nearest_landmark' => 'required',
            'brgy_loc' => 'required',
            'vulArea_lat' => 'required',
            'vulArea_lng' => 'required',
            'degree' => 'required',
        ], $messages = [
            'nearest_landmark.required' => 'The nearest landmark field is required!',
            'type.required' => 'The type of disaster field is required!',
            'brgy_loc.required' => 'The barangay field is required!',
            'nearest_landmark.required' => 'The nearest landmark field is required!',
            'brgy_loc.required' => 'The barangay field is required!',
            'vulArea_lat.required' => 'Locate the vulnerable area by clicking the map! ',
            'vulArea_lng.required' => 'Locate the vulnerable area by clicking the map! ',
            'degree.required' => 'The degree field is required!',
        ]);
        if ($validator->fails()) {
            return redirect('/user/vulnerabilitymap/create')
                ->withErrors($validator)
                ->withInput();
        } else {
            $vulnerableArea = VulnerabilityMap::create([
                'brgy_id' => NULL,
                'issued_by' => Auth::user()->first_name . ' ' . Auth::user()->last_name,
                'nearest_landmark' => $request->input('nearest_landmark'),
                'type_of_disaster' => $request->input('type'),
                'brgy_loc' => $request->input('brgy_loc'),
                'vulArea_lat' => $request->input('vulArea_lat'),
                'vulArea_lng' => $request->input('vulArea_lng'),
                'degree' => $request->input('degree'),
                'is_approved' => $request->input('is_approved'),

            ]);

            return redirect('/user/vulnerabilitymap')->with('success', 'The vulnerable area has been added!');
        }
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {

        $barangays = DB::table('barangays')
            ->where('brgy_loc', Auth::user()->brgy_loc)
            ->get();
        $vulnerablearea = VulnerabilityMap::find($id);
        //$coordinates = VulnerabilityMap::all()->where('deleted_at', NULL);
        $coordinates = DB::table('vulnerable_areas')
            ->where('deleted_at', NULL)
            ->where('id', '!=', $id)
            ->where('brgy_loc', Auth::user()->brgy_loc)
            ->get();
        return view('features.editvulnerabilitymap', [
            'vulnerablearea' => $vulnerablearea,
            'coordinates' => $coordinates,
            'barangays' => $barangays,
        ]);
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        $validator = Validator::make($request->all(), [
            'nearest_landmark' => 'required',
            'type' => 'required',
            'brgy_loc' => 'required',
            'nearest_landmark' => 'required',
            'brgy_loc' => 'required',
            'vulArea_lat' => 'required',
            'vulArea_lng' => 'required',
            'degree' => 'required',
        ], $messages = [
            'nearest_landmark.required' => 'The nearest landmark field is required!',
            'type.required' => 'The type of disaster field is required!',
            'brgy_loc.required' => 'The barangay field is required!',
            'nearest_landmark.required' => 'The nearest landmark field is required!',
            'brgy_loc.required' => 'The barangay field is required!',
            'vulArea_lat.required' => 'Locate the vulnerable area by clicking the map! ',
            'vulArea_lng.required' => 'Locate the vulnerable area by clicking the map! ',
            'degree.required' => 'The degree field is required!',
        ]);
        if ($validator->fails()) {
            return redirect('/user/vulnerabilitymap/' . $id . '/edit')
                ->withErrors($validator)
                ->withInput();
        } else {
            //$vulnerableArea = VulnerabilityMap::where('id', $id)->update([
            //    'brgy_id' => NULL,
            //    'issued_by' => Auth::user()->first_name . ' ' . Auth::user()->last_name,
            //    'nearest_landmark' => $request->input('nearest_landmark'),
            //    'type_of_disaster' => $request->input('type'),
            //    'brgy_loc' => $request->input('brgy_loc'),
            //    'vulArea_lat' => $request->input('vulArea_lat'),
            //    'vulArea_lng' => $request->input('vulArea_lng'),
            //    'degree' => $request->input('degree'),
            //
            //]);

            $vulnerableArea = VulnerabilityMap::find($id);
            $vulnerableArea->brgy_id = NULL;
            $vulnerableArea->issued_by = Auth::user()->first_name . ' ' . Auth::user()->last_name;
            $vulnerableArea->nearest_landmark = $request->input('nearest_landmark');
            $vulnerableArea->type_of_disaster = $request->input('type');
            $vulnerableArea->brgy_loc = $request->input('brgy_loc');
            $vulnerableArea->vulArea_lat = $request->input('vulArea_lat');
            $vulnerableArea->vulArea_lng = $request->input('vulArea_lng');
            $vulnerableArea->degree = $request->input('degree');
            $vulnerableArea->save();



            return redirect('/user/vulnerabilitymap')->with('success', 'The vulnerable area has been edited!');
        }
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        //$vul = VulnerabilityMap::find($id);
        //$vul->delete();
        //return redirect('/vulnerabilitymap/create');

        VulnerabilityMap::find($id)->delete();
        return response()->json(['message' => 'The vulnerable area has been deleted!']);
    }

    public function approve($id)
    {
        VulnerabilityMap::find($id)->update(['is_approved' => 1, 'updated_at' => now()]);
        return response()->json(['message' => 'The vulnerable area has been approved!']);
    }

    public function fetchLocations($brgy)
    {
        $locations = DB::table('vulnerable_areas')
            ->where('brgy_loc', $brgy)
            ->get();
        return $locations;
    }
}
