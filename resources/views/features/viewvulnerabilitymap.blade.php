@extends('layouts.master')
@section('title', '| Vulnerability Map')
@section('content')

    <script type="text/javascript">
        function initMap() {

            @if (Auth::user()->brgy_loc == 'Barangay Santolan' || Auth::user()->user_role == 1)
                var options = {
                zoom: 16,
                center: {
                lat: 14.6131,
                lng: 121.0880
                },
                }
            @endif


            var map = new google.maps.Map(document.getElementById('map'), options);

            //values from database
            var storedLocations = [
                @foreach ($vulnerableareas as $vulnerablearea)
                    ["{{ $vulnerablearea->vulArea_lat }}","{{ $vulnerablearea->vulArea_lng }}", "{{ $vulnerablearea->degree }}",
                    "{{ $vulnerablearea->id }}", "{{ $vulnerablearea->type_of_disaster }}",
                    "{{ date('F d, Y, l', strtotime($vulnerablearea->created_at)) }}",
                    "{{ date('h:i:s A', strtotime($vulnerablearea->created_at)) }}", "{{ $vulnerablearea->brgy_loc }}",],
                @endforeach
            ];

            function newLocation(newLat, newLng) {
                map.setCenter({
                    lat: newLat,
                    lng: newLng
                });
            }
            //Setting Location with jQuery
            //$(document).ready(function() {
            //    $("#brgyDelaPaz").on('click', function() {
            //        newLocation(14.6137, 121.0960);
            //    });

            //    $("#brgyManggahan").on('click', function() {
            //        newLocation(14.601887, 121.093698);
            //    });

            //    $("#brgyMaybunga").on('click', function() {
            //        newLocation(14.5763, 121.0850);
            //    });

            //    $("#brgySantolan").on('click', function() {
            //        newLocation(14.6131, 121.0880);
            //    });

            //    $("#brgyRosario").on('click', function() {
            //        newLocation(14.5885, 121.0891);
            //    });
            //});


            var infoWindow = new google.maps.InfoWindow();


            //loop coordinates from database
            for (var i = 0; i < storedLocations.length; i++) {
                var data = storedLocations[i]
                var location = new google.maps.LatLng(data[0], data[1]);
                let id = data[3];

                $('#id').val(id);


                var marker = new google.maps.Circle({
                    center: location,
                    map: map,
                    radius: 100,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillOpacity: 0.35,
                    position: location,
                    map: map,
                    html: '<ul class="list-group list-group-flush">' +
                        '<li class="list-group-item"> <i class="fas fa-map-marker-alt mr-2 color"></i><strong>Barangay: </strong>' +
                        data[7] + '</li>' +
                        '<li class="list-group-item"> <i class="far fa-bell mr-2 color"></i><strong>Type of Disaster: </strong>' +
                        data[4] + '</li>' +
                        '<li class="list-group-item"> <i class="fas fa-info-circle mr-2 color"></i><strong>Degree: </strong>' +
                        data[2] + '</li>' +
                        '<li class="list-group-item"> <i class="far fa-calendar mr-2 color"></i><strong>Date: </strong>' +
                        data[
                            5] + '</li>' +
                        '<li class="list-group-item"> <i class="far fa-clock mr-2 color"></i><strong>Time: </strong>' +
                        data[
                            6] + '</li>' +
                        '</ul>',
                });


                if (data[2] == 'High') {
                    marker.setOptions({
                        fillColor: "#FF0000",
                        strokeColor: "#FF0000",
                    });
                } else {
                    marker.setOptions({
                        fillColor: "#FFA500",
                        strokeColor: "#FFA500",
                    });
                }

                (function(marker, data) {
                    google.maps.event.addListener(marker, "click", function(e) {
                        infoWindow.setContent(marker.html);
                        infoWindow.open(map, marker);
                    });
                })(marker, data);

            }

        }
    </script>


    <div class="container-fluid mb-5" style="color: black;">

        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Vulnerability Map</h1>

            @if (Auth::user()->user_role >= 3)
                <a href="#" class="d-sm-inline-block btn btn-primary shadow-sm"><i class="fas fa-pen fa-sm text-white-50"></i>
                    Update Vulnerability Map</a>
            @elseif (Auth::user()->user_role === 1)
                <a href="{{ route('admin.vulnerabilitymap.create') }}"
                    class="d-sm-inline-block btn btn-primary shadow-sm"><i class="fas fa-pen fa-sm text-white-50"></i>
                    Update Vulnerability Map</a>
            @endif
        </div>

        <div class="card shadow">
            <div class="card-body">
                <ul class="nav nav-pills mb-3 justify-content-end" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="pills-map-tab" data-toggle="pill" href="#pills-map" role="tab"
                            aria-controls="pills-map" aria-selected="true"><i class="fas fa-columns"
                                onClick="window.location.reload();"></i></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="pills-table-tab" data-toggle="pill" href="#pills-table" role="tab"
                            aria-controls="pills-table" aria-selected="false"><i class="fas fa-list"></i></a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" id="pills-allMap-tab" data-toggle="pill" href="#pills-allMap" role="tab"
                            aria-controls="pills-allMap" aria-selected="false"><i class="fas fa-map-marked-alt"></i></a>
                    </li>

                </ul>


                <!-- MAP AND DETAILS -->
                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-map" role="tabpanel" aria-labelledby="pills-map-tab">
                        @if (count($vulnerableareas) > 0)
                            <div class="row mt-3">
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    @foreach ($vulnerableareas as $vulnerablearea)
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                @if ($vulnerablearea->is_approved === 0)
                                                    <h5><span class="badge badge-danger">Not yet Approved</span></h5>
                                                @endif

                                                <h5 class="card-title">
                                                    <strong>{{ $vulnerablearea->type_of_disaster }}</strong>
                                                </h5>
                                                <h6 class="card-subtitle mb-2 text-muted">
                                                    {{ $vulnerablearea->brgy_loc }}
                                                </h6>
                                                <div class="card-subtitle mb-2">
                                                    @if ($vulnerablearea->degree == 'High')
                                                        <span class="badge badge-danger">High Vulnerability</span>
                                                    @else
                                                        <span class="badge badge-warning">Medium Vulnerability</span>
                                                    @endif
                                                </div>
                                                <h6 class="card-subtitle mb-2">
                                                    <span class="badge badge-primary">
                                                        {{ date('F d, Y \a\t h:i:s A', strtotime($vulnerablearea->created_at)) }}</span>
                                                </h6>
                                                <p class="card-text">
                                                    <i class="fas fa-directions mr-2 color"></i>Nearest Landmark:
                                                    {{ $vulnerablearea->nearest_landmark }}</li>

                                                </p>
                                            </div>
                                        </div>
                                    @endforeach

                                    <div class="d-grid gap-2 mt-3 d-md-flex justify-content-center align-items-center">
                                        {{ $vulnerableareas->links() }}
                                    </div>



                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-8">
                                    <div id="map" style="height:500px; width: 100%;"></div>

                                    <h6 class="mt-3 font-weight-bold">Legend:</h6>
                                    <ul class="list-inline">
                                        <li class="list-inline-item"><i class="fas fa-circle mr-2"
                                                style="color:#FF0000"></i>High Vulnerability Area</li>
                                        <li class="list-inline-item"><i class="fas fa-circle mr-2"
                                                style="color:#FFA500"></i>Medium Vulnerability Area</li>
                                    </ul>
                                </div>

                            </div>

                        @else
                            <div class="card">
                                <div class="card-body">
                                    There are no vulnerable areas as of the moment.
                                </div>
                            </div>
                        @endif
                    </div>

                    <!-- TABLE -->
                    <div class="tab-pane fade" id="pills-table" role="tabpanel" aria-labelledby="pills-table-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered data-table" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Added By</th>
                                        <th>Evacuation Name</th>
                                        <th>Nearest Landmark</th>
                                        <th>Barangay Location</th>
                                        <th>Phone Number</th>
                                        <th>Capacity</th>
                                        <th>Status</th>
                                        <th>Approved</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ALL EVAC MAPS -->
                    <div class="tab-pane fade" id="pills-allMap" role="tabpanel" aria-labelledby="pills-allMap-tab">


                    </div>

                </div>




            </div>
        </div>
    </div>


    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOhN8Ve4h6uAEKm4Kh_2eznLfx0GIbOTo&callback=initMap">
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            var table = $('.data-table').DataTable({
                processing: true,
                serverSide: true,
                ajax: "{{ route('admin.vulnerabilitymap.index') }}",
                columns: [{
                        data: 'id',
                        name: 'id'
                    },
                    {
                        data: 'issued_by',
                        name: 'issued_by'
                    },
                    {
                        data: 'nearest_landmark',
                        name: 'nearest_landmark'
                    },
                    {
                        data: 'type_of_disaster',
                        name: 'type_of_disaster'
                    },
                    {
                        data: 'brgy_loc',
                        name: 'brgy_loc'
                    },
                    {
                        data: 'degree',
                        name: 'degree'
                    },
                    {
                        data: 'is_approved',
                        name: 'is_approved'
                    },
                    {
                        data: 'action',
                        name: 'action',
                        orderable: false,
                        searchable: false
                    },
                ],

            });



        });
    </script>


@endsection
