@extends('layouts.master')
@section('title', '| Vulnerability Map')
@section('content')

    <script type="text/javascript">
        function initMap() {

            @if (Auth::user()->brgy_loc == 'Barangay Santolan' || Auth::user()->user_role == 1)
                var options = {
                zoom: 16,
                center: {
                lat: 14.6131,
                lng: 121.0880
                },
                }
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Dela Paz')
                var options = {
                zoom: 16,
                center: {
                lat: 14.6137,
                lng: 121.0960
                },
                }
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Manggahan')
                var options = {
                zoom: 16,
                center: {
                lat: 14.601887,
                lng: 121.093698
                },
                }
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Maybunga')
                var options = {
                zoom: 16,
                center: {
                lat: 14.5763,
                lng: 121.0850
                },
                }
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Rosario')
                var options = {
                zoom: 16,
                center: {
                lat: 14.5885,
                lng: 121.0891
                },
                }
            @endif


            var map = new google.maps.Map(document.getElementById('map'), options);

            //values from database
            var storedLocations = [
                @foreach ($coordinates as $coordinate)
                    ["{{ $coordinate->vulArea_lat }}","{{ $coordinate->vulArea_lng }}", "{{ $coordinate->degree }}",
                    "{{ $coordinate->id }}", "{{ $coordinate->type_of_disaster }}",
                    "{{ date('F m, Y, l', strtotime($coordinate->created_at)) }}",
                    "{{ date('h:i:s A', strtotime($coordinate->created_at)) }}"],
                @endforeach
            ];

            function newLocation(newLat, newLng) {
                map.setCenter({
                    lat: newLat,
                    lng: newLng
                });
            }
            //Setting Location with jQuery
            $(document).ready(function() {
                $("#brgyDelaPaz").on('click', function() {
                    newLocation(14.6137, 121.0960);
                });

                $("#brgyManggahan").on('click', function() {
                    newLocation(14.601887, 121.093698);
                });

                $("#brgyMaybunga").on('click', function() {
                    newLocation(14.5763, 121.0850);
                });

                $("#brgySantolan").on('click', function() {
                    newLocation(14.6131, 121.0880);
                });

                $("#brgyRosario").on('click', function() {
                    newLocation(14.5885, 121.0891);
                });
            });


            var infoWindow = new google.maps.InfoWindow();


            //loop coordinates from database
            for (var i = 0; i < storedLocations.length; i++) {
                var data = storedLocations[i]
                var location = new google.maps.LatLng(data[0], data[1]);
                let id = data[3];

                $('#id').val(id);
                var marker = new google.maps.Circle({
                    center: location,
                    map: map,
                    radius: 100,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillOpacity: 0.35,
                    position: location,
                    map: map,
                    html: '<ul class="list-group list-group-flush">' +
                        '<li class="list-group-item"> <strong>Type of Disaster: </strong>' + data[4] + '</li>' +
                        '<li class="list-group-item"> <strong>Degree: </strong>' + data[2] + '</li>' +
                        '<li class="list-group-item"> <strong>Date: </strong>' + data[5] + '</li>' +
                        '<li class="list-group-item"> <strong>Time: </strong>' + data[6] + '</li>' +
                        '</ul>',
                });

                if (data[2] == 'H') {
                    marker.setOptions({
                        fillColor: "#FF0000",
                        strokeColor: "#FF0000",
                    });
                } else {
                    marker.setOptions({
                        fillColor: "#FFA500",
                        strokeColor: "#FFA500",
                    });
                }

                (function(marker, data) {
                    google.maps.event.addListener(marker, "click", function(e) {
                        infoWindow.setContent(marker.html);
                        infoWindow.open(map, marker);
                    });
                })(marker, data);

            }

        }
    </script>


    <div class="container-fluid" style="color: black;">
        <div class="row">
            <div class="col-sm-12 col-md-8">
                <h1 class="h3 mb-4 text-gray-800">Vulnerability Map</h1>
            </div>
            @if (Auth::user()->user_role === 1 || Auth::user()->user_role === 3)
                <div class="col-sm-12 col-md-4">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        @if (Auth::user()->user_role === 3)
                            <a href="{{ route('brgy_official.vulnerabilitymap.create') }}" class="btn btn-primary">Update
                                Vulnerability
                                Map</a>
                        @elseif (Auth::user()->user_role === 1)
                            <a href="{{ route('admin.vulnerabilitymap.create') }}" class="btn btn-primary">Update
                                Vulnerability
                                Map</a>
                        @endif
                    </div>
                </div>
            @endif
        </div>
        @if (Auth::user()->user_role === 1)
            <form class="mb-3">
                <p class="vul-caption mt-3">Choose the barangay:</p>
                <div class="radio-button-wrap mt-2">
                    <input type="radio" name="brgy_loc" id="brgyDelaPaz" value="Barangay Dela Paz" hidden>
                    <label for="brgyDelaPaz" class="button-label">Barangay Dela Paz</label>

                    <input type="radio" name="brgy_loc" id="brgyManggahan" value="Barangay Manggahan" hidden>
                    <label for="brgyManggahan" class="button-label">Barangay Manggahan</label>

                    <input type="radio" name="brgy_loc" id="brgyMaybunga" value="Barangay Maybunga" hidden>
                    <label for="brgyMaybunga" class="button-label">Barangay Maybunga</label>

                    <input type="radio" name="brgy_loc" id="brgySantolan" value="Barangay Santolan" hidden>
                    <label for="brgySantolan" class="button-label">Barangay Santolan</label>

                    <input type="radio" name="brgy_loc" id="brgyRosario" value="Barangay Rosario" hidden>
                    <label for="brgyRosario" class="button-label">Barangay Rosario</label>
                </div>
            </form>
        @endif

        <div class="card shadow-card mb-3 mt-3">
            <div class="card-body">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </div>

        <div>
            <div class="container px-lg-5">
                <h3 style="font-weight:700">Legends:</h3>
                <div class="row mx-lg-n5">
                    <div class="col py-3 px-lg-5"> <span class="fa fa-circle fa-4x icon-legend"
                            style=" vertical-align: middle; color: #FFA500"></span>
                        <span class="legend-text">Medium Vulnerability Area</span>
                    </div>
                    <div class="col py-3 px-lg-5"> <span class="fa fa-circle fa-4x icon-legend"
                            style=" vertical-align: middle; color: #F00"></span>
                        <span class="legend-text">High Vulnerability Area</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOhN8Ve4h6uAEKm4Kh_2eznLfx0GIbOTo&callback=initMap">
    </script>



@endsection
