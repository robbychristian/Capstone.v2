@extends('layouts.master')
@section('title', '| Vulnerability Map')
@section('content')

    <script type="text/javascript">
        let map;
        let markers = [];

        //values from database
        var storedLocations = [
            @foreach ($coordinates as $coordinate)
                ["{{ $coordinate->vulArea_lat }}","{{ $coordinate->vulArea_lng }}", "{{ $coordinate->degree }}",
                "{{ $coordinate->id }}" , "{{ $coordinate->brgy_loc }}"],
            @endforeach
        ];

        function initMap() {

            const brgyDelaPaz = {
                lat: 14.6137,
                lng: 121.0960
            }

            const brgyManggahan = {
                lat: 14.601887,
                lng: 121.093698
            }

            const brgyMaybunga = {
                lat: 14.5763,
                lng: 121.0850
            }

            const brgyRosario = {
                lat: 14.5885,
                lng: 121.0891
            }

            const brgySantolan = {
                lat: 14.6131,
                lng: 121.0880,
            };

            @if (Auth::user()->brgy_loc == 'Barangay Santolan' || Auth::user()->user_role == 1)
                map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: brgySantolan,
                });
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Dela Paz')
                map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: brgyDelaPaz,
                });
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Manggahan')
                map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: brgyManggahan,
                });
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Maybunga')
                map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: brgyMaybunga,
                });
            @endif

            @if (Auth::user()->brgy_loc == 'Barangay Rosario')
                map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16,
                center: brgyRosario,
                });
            @endif

            function newLocation(newLat, newLng) {
                map.setCenter({
                    lat: newLat,
                    lng: newLng
                });
            }
            //Setting Location with jQuery
            $(document).ready(function() {
                $("#brgyDelaPaz").on('click', function() {
                    newLocation(14.6137, 121.0960);
                });

                $("#brgyManggahan").on('click', function() {
                    newLocation(14.601887, 121.093698);
                });

                $("#brgyMaybunga").on('click', function() {
                    newLocation(14.5763, 121.0850);
                });

                $("#brgySantolan").on('click', function() {
                    newLocation(14.6131, 121.0880);
                });

                $("#brgyRosario").on('click', function() {
                    newLocation(14.5885, 121.0891);
                });
            });

            var infoWindow = new google.maps.InfoWindow();

            //loop coordinates from database
            for (var i = 0; i < storedLocations.length; i++) {
                var data = storedLocations[i]
                var location = new google.maps.LatLng(data[0], data[1]);
                let id = data[3];

                $('#id').val(id);
                @if (Auth::user()->user_role === 1)
                    var marker = new google.maps.Circle({
                    center: location,
                    map: map,
                    radius: 100,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillOpacity: 0.35,
                    position: location,
                    map: map,
                    //icon: data[2] == "H" ? red_circle : orange_circle,
                    html:
                    '<form action="/admin/vulnerabilitymap/' + data[3] + '" method="post">' +
                        '@csrf' +
                        '@method("DELETE")' +
                        '<input class="btn btn-danger btn-lg btn-block" type="submit" value="Delete Marker" onclick="showSuccess()">' +
                        '</form>',
                    });
                @endif
                @if (Auth::user()->user_role === 3)
                    var marker = new google.maps.Circle({
                    center: location,
                    map: map,
                    radius: 100,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillOpacity: 0.35,
                    position: location,
                    map: map,
                    //icon: data[2] == "H" ? red_circle : orange_circle,
                    html:
                    '<form action="/brgy_official/vulnerabilitymap/' + data[3] + '" method="post">' +
                        '@csrf' +
                        '@method("DELETE")' +
                        '<input class="btn btn-danger btn-lg btn-block" type="submit" value="Delete Marker" onclick="showSuccess()">' +
                        '</form>',
                    });
                @endif

                    (function(marker, data) {
                        google.maps.event.addListener(marker, "click", function(e) {
                            infoWindow.setContent(marker.html);
                            infoWindow.open(map, marker);
                        });
                    })(marker, data);

                if (data[2] == 'H') {
                    marker.setOptions({
                        fillColor: "#FF0000",
                        strokeColor: "#FF0000",
                    });
                } else {
                    marker.setOptions({
                        fillColor: "#FFA500",
                        strokeColor: "#FFA500",
                    });
                }

            }


            // This event listener will call addMarker() when the map is clicked.

            var degreeBtn = document.getElementsByName('degree');
            var brgy = document.getElementsByName('brgy_loc');

            @if (Auth::user()->user_role === 1)
                map.addListener("click", (event) => {
                if (!(degreeBtn[0].checked || degreeBtn[1].checked)) {
                swal({
                title: "Warning!",
                text: "Please choose a degree!",
                icon: "warning",
                });
                } else if (!(brgy[0].checked || brgy[1].checked || brgy[2].checked || brgy[3].checked || brgy[4]
                .checked)) {
                swal({
                title: "Warning!",
                text: "Please choose a barangay!",
                icon: "warning",
                });
                } else {
                addMarker(event.latLng);
                }
            
                });
            @endif

            @if (Auth::user()->user_role === 3)
                map.addListener("click", (event) => {
                if (!(degreeBtn[0].checked || degreeBtn[1].checked)) {
                swal({
                title: "Warning!",
                text: "Please choose a degree!",
                icon: "warning",
                });
                } else {
                addMarker(event.latLng);
                }
            
                });
            @endif


            // Adds a marker at the center of the map.
            addMarker();

        }

        // Adds a marker to the map and push to the array.
        function addMarker(position) {
            const marker = new google.maps.Circle({
                center: position,
                map: map,
                radius: 100,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillOpacity: 0.35,
                position: position,
                map: map,
                fillColor: "#808080",
                strokeColor: "#808080",
            });


            markers.push(marker);

            let vulArea_lat = position.lat();
            let vulArea_lng = position.lng();

            $('#vulArea_lat').val(vulArea_lat);
            $('#vulArea_lng').val(vulArea_lng);
            submitForm(form);
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function hideMarkers() {
            setMapOnAll(null);
        }

        function showSuccess() {
            swal("Success!", "The marker has been deleted!", "success");
        }

        //submits the data
        function submitForm(form) {
            event.preventDefault();
            swal({
                    title: "Are you sure?",
                    text: "Once confirmed, this will be tagged as vulnerable area.",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                    closeOnClickOutside: false,
                    closeOnEsc: false,
                })
                .then((isOkay) => {
                    if (isOkay) {
                        form.submit();
                        swal("The map has been updated.", {
                            icon: "success",
                            timer: 3000,
                        });
                    } else {
                        hideMarkers();
                    }
                });
            return false;
        }

        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script>

    <div class="container-fluid" style="color: black;">

        <h1 class="h3 mb-4 text-gray-800">Update Vulnerability Map</h1>

        @if (Auth::user()->user_role === 1)
            <form class="needs-validation mb-3" novalidate action="{{ route('admin.vulnerabilitymap.store') }}"
                method="POST" id="form">
            @elseif (Auth::user()->user_role === 3)
                <form class="needs-validation mb-3" novalidate action="{{ route('brgy_official.vulnerabilitymap.store') }}"
                    method="POST" id="form">
        @endif
        @csrf


        <p class="vul-caption">Choose the degree of vulnerability in the area:</p>
        <div class="radio-button-wrap mt-2">
            <input type="radio" name="degree" id="degreeHigh" value="H" hidden>
            <label for="degreeHigh" class="button-label">High</label>
            <input type="radio" name="degree" id="degreeMedium" value="M" hidden>
            <label for="degreeMedium" class="button-label">Medium</label>
        </div>
        <div class="form-row mb-3">
            <div class="form-group col-md-6">
                <label>Type of Disaster</label>
                <select id="inputDisaster" class="form-control" name="typeOfdisaster">
                    <option value="" disabled>Disaster</option>
                    <option value='Typhoon'>Typhoon</option>
                    <option value='Flood'>Flood</option>
                    <option value='Low Pressure Area'>Low Pressure Area</option>
                    <option value='Earthquake'>Earthquake</option>
                    <option value='Landslide'>Landslide</option>
                    <option value='Others'>Others</option>
                </select>
                <small class="text-danger">@error('typeOfdisaster')
                        {{ $message }}
                    @enderror</small>
            </div>
        </div>
        @if (Auth::user()->user_role === 1)
            <p class="vul-caption mt-3">Choose the barangay:</p>
            <div class="radio-button-wrap mt-2">
                <input type="radio" name="brgy_loc" id="brgyDelaPaz" value="Barangay Dela Paz" hidden>
                <label for="brgyDelaPaz" class="button-label">Barangay Dela Paz</label>

                <input type="radio" name="brgy_loc" id="brgyManggahan" value="Barangay Manggahan" hidden>
                <label for="brgyManggahan" class="button-label">Barangay Manggahan</label>

                <input type="radio" name="brgy_loc" id="brgyMaybunga" value="Barangay Maybunga" hidden>
                <label for="brgyMaybunga" class="button-label">Barangay Maybunga</label>

                <input type="radio" name="brgy_loc" id="brgySantolan" value="Barangay Santolan" hidden>
                <label for="brgySantolan" class="button-label">Barangay Santolan</label>

                <input type="radio" name="brgy_loc" id="brgyRosario" value="Barangay Rosario" hidden>
                <label for="brgyRosario" class="button-label">Barangay Rosario</label>
            </div>

        @endif

        <div class="row">
            <div class="col">
                @if (Auth::user()->user_role === 3)
                    <input type="text" class="form-control" placeholder="{{ Auth::user()->brgy_loc }}" id="barangay"
                        name="brgy_loc" value="{{ Auth::user()->brgy_loc }}" hidden>
                @endif
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="Latitude" id="vulArea_lat" name="vulArea_lat" hidden>
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="Longitude" id="vulArea_lng" name="vulArea_lng"
                    hidden>
            </div>
        </div>
        </form>
        <div class="card shadow-card mb-5">
            <div class="card-body">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </div>

    </div>


    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOhN8Ve4h6uAEKm4Kh_2eznLfx0GIbOTo&callback=initMap">
    </script>
@endsection
